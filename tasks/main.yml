---
- name: Run docker network inspect
  command: docker network inspect bridge
  register: docker_inspect_output
  changed_when: false
  failed_when: docker_inspect_output.rc != 0 and 'No such network' not in docker_inspect_output.stderr

- name: Docker bridge network gateway IP
  set_fact:
    docker_gateway_ip: "{{ (docker_inspect_output.stdout | from_json)[0].IPAM.Config[0].Gateway }}"

- name: Update apt cache
  ansible.builtin.apt:
    update_cache: true

- name: Ensure Valkey is installed.
  ansible.builtin.apt:
    name: "{{ valkey_package_debian }}"
    state: present

- name: Verify Valkey include directory exists.
  ansible.builtin.file:
    path: "{{ valkey_conf_include_dir }}"
    state: directory
    owner: "{{ valkey_user }}"
    group: "{{ valkey_group }}"
    mode: 0755

- name: Update Valkey configuration to include overrides.
  ansible.builtin.lineinfile:
    dest: "{{ valkey_conf_dir }}/valkey.conf"
    regexp: "{{ item.regexp }}"
    line: "{{ item.line }}"
    state: present
  with_items:
    - regexp: "^include"
      line: "include {{ valkey_conf_include_dir }}/*.conf"

- name: Copy my.cnf override files into include directory.
  ansible.builtin.template:
    src: overrides.conf.j2
    dest: "{{ valkey_conf_include_dir }}/overrides.conf"
    owner: "{{ valkey_user }}"
    group: "{{ valkey_group }}"
    mode: 0644
  notify: restart valkey

- name: Ensure systemd override directory exists.
  ansible.builtin.file:
    path: /etc/systemd/system/valkey-server.service.d
    state: directory
    owner: root
    group: root
    mode: 0755

- name: Deploy systemd drop-in to start Valkey after Docker and Tailscale.
  ansible.builtin.template:
    src: systemd-override.conf.j2
    dest: /etc/systemd/system/valkey-server.service.d/override.conf
    owner: root
    group: root
    mode: 0644
  notify:
    - reload systemd
    - restart valkey

- name: Ensure Valkey service is enabled and started
  ansible.builtin.service:
    name: "{{ valkey_daemon }}"
    enabled: true
    state: started
